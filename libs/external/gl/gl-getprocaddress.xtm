;;; gl-getprocaddress.xtm -- GetProcAddress-style OpenGL bindings

;; Author: Ben Swift
;; Keywords: extempore
;; Required dylibs: libGL

;;; Commentary:

;; This library contains some xtlang compiler additions to bind OpenGL
;; functions using the "GetProcAddress" approach. This stuff is pretty
;; messy, although hopefully it makes all the user-facing OpenGL code
;; cleaner.

;; here are some compiler additions to deal with the messiness of
;; using GL extensions in a robust, cross-platform way. It's
;; necessary, but not necessarily nice - so let's keep it isolated in
;; this gl.xtm library

;; the basic idea is that we use a big array to keep track of the
;; OpenGL function pointers, and then create xtlang closures which
;; look up the right function pointer, cast it to the right signature,
;; and then call it with the required arguments

;; here's a big "lookup table" to match an OpenGL procedure name to an
;; index into the function pointer array. To re-create, load the
;; direct-bind version (on a platform where it works, e.g. OSX) and
;; copy the output of:

;; (for-each (let ((count 0))
;;             (lambda (x)
;;               (if (regex:match? (car x) "^gl")
;;                   (begin
;;                     (println (cons (car x) count))
;;                     (set! count (+ count 1))))))
;;           *impc:ti:nativefunc-cache*)

;; **NOTE** if you add/remove any names from this list, make sure you
;; adjust the size of the EXTEMPORE_GL_FUNCTION_POINTER_COUNT global
;; variable further down in this file

;;; Code:

(impc:aot:do-and-emit
 (define *impc:ti:gl-proc-alist*
   '(("glAccum" . 0)
     ("glActiveShaderProgram" . 1)
     ("glActiveTexture" . 2)
     ("glAlphaFunc" . 3)
     ("glAreTexturesResident" . 4)
     ("glArrayElement" . 5)
     ("glAttachShader" . 6)
     ("glBegin" . 7)
     ("glBeginConditionalRender" . 8)
     ("glBeginQuery" . 9)
     ("glBeginQueryIndexed" . 10)
     ("glBeginTransformFeedback" . 11)
     ("glBindAttribLocation" . 12)
     ("glBindBuffer" . 13)
     ("glBindBufferBase" . 14)
     ("glBindBufferRange" . 15)
     ("glBindFragDataLocation" . 16)
     ("glBindFragDataLocationIndexed" . 17)
     ("glBindFramebuffer" . 18)
     ("glBindProgramPipeline" . 19)
     ("glBindRenderbuffer" . 20)
     ("glBindSampler" . 21)
     ("glBindTexture" . 22)
     ("glBindTransformFeedback" . 23)
     ("glBindVertexArray" . 24)
     ("glBitmap" . 25)
     ("glBlendColor" . 26)
     ("glBlendEquation" . 27)
     ("glBlendEquationSeparate" . 28)
     ("glBlendEquationSeparatei" . 29)
     ("glBlendEquationi" . 30)
     ("glBlendFunc" . 31)
     ("glBlendFuncSeparate" . 32)
     ("glBlendFuncSeparatei" . 33)
     ("glBlendFunci" . 34)
     ("glBlitFramebuffer" . 35)
     ("glBufferData" . 36)
     ("glBufferSubData" . 37)
     ("glCallList" . 38)
     ("glCallLists" . 39)
     ("glCheckFramebufferStatus" . 40)
     ("glClampColor" . 41)
     ("glClear" . 42)
     ("glClearAccum" . 43)
     ("glClearBufferfi" . 44)
     ("glClearBufferfv" . 45)
     ("glClearBufferiv" . 46)
     ("glClearBufferuiv" . 47)
     ("glClearColor" . 48)
     ("glClearDepth" . 49)
     ("glClearDepthf" . 50)
     ("glClearIndex" . 51)
     ("glClearStencil" . 52)
     ("glClientActiveTexture" . 53)
     ("glClientWaitSync" . 54)
     ("glClipPlane" . 55)
     ("glColor3b" . 56)
     ("glColor3bv" . 57)
     ("glColor3d" . 58)
     ("glColor3dv" . 59)
     ("glColor3f" . 60)
     ("glColor3fv" . 61)
     ("glColor3i" . 62)
     ("glColor3iv" . 63)
     ("glColor3s" . 64)
     ("glColor3sv" . 65)
     ("glColor3ub" . 66)
     ("glColor3ubv" . 67)
     ("glColor3ui" . 68)
     ("glColor3uiv" . 69)
     ("glColor3us" . 70)
     ("glColor3usv" . 71)
     ("glColor4b" . 72)
     ("glColor4bv" . 73)
     ("glColor4d" . 74)
     ("glColor4dv" . 75)
     ("glColor4f" . 76)
     ("glColor4fv" . 77)
     ("glColor4i" . 78)
     ("glColor4iv" . 79)
     ("glColor4s" . 80)
     ("glColor4sv" . 81)
     ("glColor4ub" . 82)
     ("glColor4ubv" . 83)
     ("glColor4ui" . 84)
     ("glColor4uiv" . 85)
     ("glColor4us" . 86)
     ("glColor4usv" . 87)
     ("glColorMask" . 88)
     ("glColorMaski" . 89)
     ("glColorMaterial" . 90)
     ("glColorPointer" . 91)
     ("glColorSubTable" . 92)
     ("glColorTable" . 93)
     ("glColorTableParameterfv" . 94)
     ("glColorTableParameteriv" . 95)
     ("glCompileShader" . 96)
     ("glCompressedTexImage1D" . 97)
     ("glCompressedTexImage2D" . 98)
     ("glCompressedTexImage3D" . 99)
     ("glCompressedTexSubImage1D" . 100)
     ("glCompressedTexSubImage2D" . 101)
     ("glCompressedTexSubImage3D" . 102)
     ("glConvolutionFilter1D" . 103)
     ("glConvolutionFilter2D" . 104)
     ("glConvolutionParameterf" . 105)
     ("glConvolutionParameterfv" . 106)
     ("glConvolutionParameteri" . 107)
     ("glConvolutionParameteriv" . 108)
     ("glCopyBufferSubData" . 109)
     ("glCopyColorSubTable" . 110)
     ("glCopyColorTable" . 111)
     ("glCopyConvolutionFilter1D" . 112)
     ("glCopyConvolutionFilter2D" . 113)
     ("glCopyPixels" . 114)
     ("glCopyTexImage1D" . 115)
     ("glCopyTexImage2D" . 116)
     ("glCopyTexSubImage1D" . 117)
     ("glCopyTexSubImage2D" . 118)
     ("glCopyTexSubImage3D" . 119)
     ("glCreateProgram" . 120)
     ("glCreateShader" . 121)
     ("glCreateShaderProgramv" . 122)
     ("glCullFace" . 123)
     ("glDeleteBuffers" . 124)
     ("glDeleteFramebuffers" . 125)
     ("glDeleteLists" . 126)
     ("glDeleteProgram" . 127)
     ("glDeleteProgramPipelines" . 128)
     ("glDeleteQueries" . 129)
     ("glDeleteRenderbuffers" . 130)
     ("glDeleteSamplers" . 131)
     ("glDeleteShader" . 132)
     ("glDeleteSync" . 133)
     ("glDeleteTextures" . 134)
     ("glDeleteTransformFeedbacks" . 135)
     ("glDeleteVertexArrays" . 136)
     ("glDepthFunc" . 137)
     ("glDepthMask" . 138)
     ("glDepthRange" . 139)
     ("glDepthRangeArrayv" . 140)
     ("glDepthRangeIndexed" . 141)
     ("glDepthRangef" . 142)
     ("glDetachShader" . 143)
     ("glDisable" . 144)
     ("glDisableClientState" . 145)
     ("glDisableVertexAttribArray" . 146)
     ("glDisablei" . 147)
     ("glDrawArrays" . 148)
     ("glDrawArraysIndirect" . 149)
     ("glDrawArraysInstanced" . 150)
     ("glDrawBuffer" . 151)
     ("glDrawBuffers" . 152)
     ("glDrawElements" . 153)
     ("glDrawElementsBaseVertex" . 154)
     ("glDrawElementsIndirect" . 155)
     ("glDrawElementsInstanced" . 156)
     ("glDrawElementsInstancedBaseVertex" . 157)
     ("glDrawPixels" . 158)
     ("glDrawRangeElements" . 159)
     ("glDrawRangeElementsBaseVertex" . 160)
     ("glDrawTransformFeedback" . 161)
     ("glDrawTransformFeedbackStream" . 162)
     ("glEdgeFlag" . 163)
     ("glEdgeFlagPointer" . 164)
     ("glEdgeFlagv" . 165)
     ("glEnable" . 166)
     ("glEnableClientState" . 167)
     ("glEnableVertexAttribArray" . 168)
     ("glEnablei" . 169)
     ("glEnd" . 170)
     ("glEndConditionalRender" . 171)
     ("glEndList" . 172)
     ("glEndQuery" . 173)
     ("glEndQueryIndexed" . 174)
     ("glEndTransformFeedback" . 175)
     ("glEvalCoord1d" . 176)
     ("glEvalCoord1dv" . 177)
     ("glEvalCoord1f" . 178)
     ("glEvalCoord1fv" . 179)
     ("glEvalCoord2d" . 180)
     ("glEvalCoord2dv" . 181)
     ("glEvalCoord2f" . 182)
     ("glEvalCoord2fv" . 183)
     ("glEvalMesh1" . 184)
     ("glEvalMesh2" . 185)
     ("glEvalPoint1" . 186)
     ("glEvalPoint2" . 187)
     ("glFeedbackBuffer" . 188)
     ("glFenceSync" . 189)
     ("glFinish" . 190)
     ("glFlush" . 191)
     ("glFlushMappedBufferRange" . 192)
     ("glFogCoordPointer" . 193)
     ("glFogCoordd" . 194)
     ("glFogCoorddv" . 195)
     ("glFogCoordf" . 196)
     ("glFogCoordfv" . 197)
     ("glFogf" . 198)
     ("glFogfv" . 199)
     ("glFogi" . 200)
     ("glFogiv" . 201)
     ("glFramebufferRenderbuffer" . 202)
     ("glFramebufferTexture" . 203)
     ("glFramebufferTexture1D" . 204)
     ("glFramebufferTexture2D" . 205)
     ("glFramebufferTexture3D" . 206)
     ("glFramebufferTextureLayer" . 207)
     ("glFrontFace" . 208)
     ("glFrustum" . 209)
     ("glGenBuffers" . 210)
     ("glGenFramebuffers" . 211)
     ("glGenLists" . 212)
     ("glGenProgramPipelines" . 213)
     ("glGenQueries" . 214)
     ("glGenRenderbuffers" . 215)
     ("glGenSamplers" . 216)
     ("glGenTextures" . 217)
     ("glGenTransformFeedbacks" . 218)
     ("glGenVertexArrays" . 219)
     ("glGenerateMipmap" . 220)
     ("glGetActiveAttrib" . 221)
     ("glGetActiveSubroutineName" . 222)
     ("glGetActiveSubroutineUniformName" . 223)
     ("glGetActiveSubroutineUniformiv" . 224)
     ("glGetActiveUniform" . 225)
     ("glGetActiveUniformBlockName" . 226)
     ("glGetActiveUniformBlockiv" . 227)
     ("glGetActiveUniformName" . 228)
     ("glGetActiveUniformsiv" . 229)
     ("glGetAttachedShaders" . 230)
     ("glGetAttribLocation" . 231)
     ("glGetBooleani_v" . 232)
     ("glGetBooleanv" . 233)
     ("glGetBufferParameteri64v" . 234)
     ("glGetBufferParameteriv" . 235)
     ("glGetBufferPointerv" . 236)
     ("glGetBufferSubData" . 237)
     ("glGetClipPlane" . 238)
     ("glGetColorTable" . 239)
     ("glGetColorTableParameterfv" . 240)
     ("glGetColorTableParameteriv" . 241)
     ("glGetCompressedTexImage" . 242)
     ("glGetConvolutionFilter" . 243)
     ("glGetConvolutionParameterfv" . 244)
     ("glGetConvolutionParameteriv" . 245)
     ("glGetDoublei_v" . 246)
     ("glGetDoublev" . 247)
     ("glGetError" . 248)
     ("glGetFloati_v" . 249)
     ("glGetFloatv" . 250)
     ("glGetFragDataIndex" . 251)
     ("glGetFragDataLocation" . 252)
     ("glGetFramebufferAttachmentParameteriv" . 253)
     ("glGetHistogram" . 254)
     ("glGetHistogramParameterfv" . 255)
     ("glGetHistogramParameteriv" . 256)
     ("glGetInteger64i_v" . 257)
     ("glGetInteger64v" . 258)
     ("glGetIntegeri_v" . 259)
     ("glGetIntegerv" . 260)
     ("glGetLightfv" . 261)
     ("glGetLightiv" . 262)
     ("glGetMapdv" . 263)
     ("glGetMapfv" . 264)
     ("glGetMapiv" . 265)
     ("glGetMaterialfv" . 266)
     ("glGetMaterialiv" . 267)
     ("glGetMinmax" . 268)
     ("glGetMinmaxParameterfv" . 269)
     ("glGetMinmaxParameteriv" . 270)
     ("glGetMultisamplefv" . 271)
     ("glGetPixelMapfv" . 272)
     ("glGetPixelMapuiv" . 273)
     ("glGetPixelMapusv" . 274)
     ("glGetPointerv" . 275)
     ("glGetPolygonStipple" . 276)
     ("glGetProgramBinary" . 277)
     ("glGetProgramInfoLog" . 278)
     ("glGetProgramPipelineInfoLog" . 279)
     ("glGetProgramPipelineiv" . 280)
     ("glGetProgramStageiv" . 281)
     ("glGetProgramiv" . 282)
     ("glGetQueryIndexediv" . 283)
     ("glGetQueryObjecti64v" . 284)
     ("glGetQueryObjectiv" . 285)
     ("glGetQueryObjectui64v" . 286)
     ("glGetQueryObjectuiv" . 287)
     ("glGetQueryiv" . 288)
     ("glGetRenderbufferParameteriv" . 289)
     ("glGetSamplerParameterIiv" . 290)
     ("glGetSamplerParameterIuiv" . 291)
     ("glGetSamplerParameterfv" . 292)
     ("glGetSamplerParameteriv" . 293)
     ("glGetSeparableFilter" . 294)
     ("glGetShaderInfoLog" . 295)
     ("glGetShaderPrecisionFormat" . 296)
     ("glGetShaderSource" . 297)
     ("glGetShaderiv" . 298)
     ("glGetString" . 299)
     ("glGetStringi" . 300)
     ("glGetSubroutineIndex" . 301)
     ("glGetSubroutineUniformLocation" . 302)
     ("glGetSynciv" . 303)
     ("glGetTexEnvfv" . 304)
     ("glGetTexEnviv" . 305)
     ("glGetTexGendv" . 306)
     ("glGetTexGenfv" . 307)
     ("glGetTexGeniv" . 308)
     ("glGetTexImage" . 309)
     ("glGetTexLevelParameterfv" . 310)
     ("glGetTexLevelParameteriv" . 311)
     ("glGetTexParameterIiv" . 312)
     ("glGetTexParameterIuiv" . 313)
     ("glGetTexParameterfv" . 314)
     ("glGetTexParameteriv" . 315)
     ("glGetTransformFeedbackVarying" . 316)
     ("glGetUniformBlockIndex" . 317)
     ("glGetUniformIndices" . 318)
     ("glGetUniformLocation" . 319)
     ("glGetUniformSubroutineuiv" . 320)
     ("glGetUniformdv" . 321)
     ("glGetUniformfv" . 322)
     ("glGetUniformiv" . 323)
     ("glGetUniformuiv" . 324)
     ("glGetVertexAttribIiv" . 325)
     ("glGetVertexAttribIuiv" . 326)
     ("glGetVertexAttribLdv" . 327)
     ("glGetVertexAttribPointerv" . 328)
     ("glGetVertexAttribdv" . 329)
     ("glGetVertexAttribfv" . 330)
     ("glGetVertexAttribiv" . 331)
     ("glHint" . 332)
     ("glHistogram" . 333)
     ("glIndexMask" . 334)
     ("glIndexPointer" . 335)
     ("glIndexd" . 336)
     ("glIndexdv" . 337)
     ("glIndexf" . 338)
     ("glIndexfv" . 339)
     ("glIndexi" . 340)
     ("glIndexiv" . 341)
     ("glIndexs" . 342)
     ("glIndexsv" . 343)
     ("glIndexub" . 344)
     ("glIndexubv" . 345)
     ("glInitNames" . 346)
     ("glInterleavedArrays" . 347)
     ("glIsBuffer" . 348)
     ("glIsEnabled" . 349)
     ("glIsEnabledi" . 350)
     ("glIsFramebuffer" . 351)
     ("glIsList" . 352)
     ("glIsProgram" . 353)
     ("glIsProgramPipeline" . 354)
     ("glIsQuery" . 355)
     ("glIsRenderbuffer" . 356)
     ("glIsSampler" . 357)
     ("glIsShader" . 358)
     ("glIsSync" . 359)
     ("glIsTexture" . 360)
     ("glIsTransformFeedback" . 361)
     ("glIsVertexArray" . 362)
     ("glLightModelf" . 363)
     ("glLightModelfv" . 364)
     ("glLightModeli" . 365)
     ("glLightModeliv" . 366)
     ("glLightf" . 367)
     ("glLightfv" . 368)
     ("glLighti" . 369)
     ("glLightiv" . 370)
     ("glLineStipple" . 371)
     ("glLineWidth" . 372)
     ("glLinkProgram" . 373)
     ("glListBase" . 374)
     ("glLoadIdentity" . 375)
     ("glLoadMatrixd" . 376)
     ("glLoadMatrixf" . 377)
     ("glLoadName" . 378)
     ("glLoadTransposeMatrixd" . 379)
     ("glLoadTransposeMatrixf" . 380)
     ("glLogicOp" . 381)
     ("glMap1d" . 382)
     ("glMap1f" . 383)
     ("glMap2d" . 384)
     ("glMap2f" . 385)
     ("glMapBuffer" . 386)
     ("glMapBufferRange" . 387)
     ("glMapGrid1d" . 388)
     ("glMapGrid1f" . 389)
     ("glMapGrid2d" . 390)
     ("glMapGrid2f" . 391)
     ("glMaterialf" . 392)
     ("glMaterialfv" . 393)
     ("glMateriali" . 394)
     ("glMaterialiv" . 395)
     ("glMatrixMode" . 396)
     ("glMinSampleShading" . 397)
     ("glMinmax" . 398)
     ("glMultMatrixd" . 399)
     ("glMultMatrixf" . 400)
     ("glMultTransposeMatrixd" . 401)
     ("glMultTransposeMatrixf" . 402)
     ("glMultiDrawArrays" . 403)
     ("glMultiDrawElements" . 404)
     ("glMultiDrawElementsBaseVertex" . 405)
     ("glMultiTexCoord1d" . 406)
     ("glMultiTexCoord1dv" . 407)
     ("glMultiTexCoord1f" . 408)
     ("glMultiTexCoord1fv" . 409)
     ("glMultiTexCoord1i" . 410)
     ("glMultiTexCoord1iv" . 411)
     ("glMultiTexCoord1s" . 412)
     ("glMultiTexCoord1sv" . 413)
     ("glMultiTexCoord2d" . 414)
     ("glMultiTexCoord2dv" . 415)
     ("glMultiTexCoord2f" . 416)
     ("glMultiTexCoord2fv" . 417)
     ("glMultiTexCoord2i" . 418)
     ("glMultiTexCoord2iv" . 419)
     ("glMultiTexCoord2s" . 420)
     ("glMultiTexCoord2sv" . 421)
     ("glMultiTexCoord3d" . 422)
     ("glMultiTexCoord3dv" . 423)
     ("glMultiTexCoord3f" . 424)
     ("glMultiTexCoord3fv" . 425)
     ("glMultiTexCoord3i" . 426)
     ("glMultiTexCoord3iv" . 427)
     ("glMultiTexCoord3s" . 428)
     ("glMultiTexCoord3sv" . 429)
     ("glMultiTexCoord4d" . 430)
     ("glMultiTexCoord4dv" . 431)
     ("glMultiTexCoord4f" . 432)
     ("glMultiTexCoord4fv" . 433)
     ("glMultiTexCoord4i" . 434)
     ("glMultiTexCoord4iv" . 435)
     ("glMultiTexCoord4s" . 436)
     ("glMultiTexCoord4sv" . 437)
     ("glNewList" . 438)
     ("glNormal3b" . 439)
     ("glNormal3bv" . 440)
     ("glNormal3d" . 441)
     ("glNormal3dv" . 442)
     ("glNormal3f" . 443)
     ("glNormal3fv" . 444)
     ("glNormal3i" . 445)
     ("glNormal3iv" . 446)
     ("glNormal3s" . 447)
     ("glNormal3sv" . 448)
     ("glNormalPointer" . 449)
     ("glOrtho" . 450)
     ("glPassThrough" . 451)
     ("glPatchParameterfv" . 452)
     ("glPatchParameteri" . 453)
     ("glPauseTransformFeedback" . 454)
     ("glPixelMapfv" . 455)
     ("glPixelMapuiv" . 456)
     ("glPixelMapusv" . 457)
     ("glPixelStoref" . 458)
     ("glPixelStorei" . 459)
     ("glPixelTransferf" . 460)
     ("glPixelTransferi" . 461)
     ("glPixelZoom" . 462)
     ("glPointParameterf" . 463)
     ("glPointParameterfv" . 464)
     ("glPointParameteri" . 465)
     ("glPointParameteriv" . 466)
     ("glPointSize" . 467)
     ("glPolygonMode" . 468)
     ("glPolygonOffset" . 469)
     ("glPolygonStipple" . 470)
     ("glPopAttrib" . 471)
     ("glPopClientAttrib" . 472)
     ("glPopMatrix" . 473)
     ("glPopName" . 474)
     ("glPrimitiveRestartIndex" . 475)
     ("glPrioritizeTextures" . 476)
     ("glProgramBinary" . 477)
     ("glProgramParameteri" . 478)
     ("glProgramUniform1d" . 479)
     ("glProgramUniform1dv" . 480)
     ("glProgramUniform1f" . 481)
     ("glProgramUniform1fv" . 482)
     ("glProgramUniform1i" . 483)
     ("glProgramUniform1iv" . 484)
     ("glProgramUniform1ui" . 485)
     ("glProgramUniform1uiv" . 486)
     ("glProgramUniform2d" . 487)
     ("glProgramUniform2dv" . 488)
     ("glProgramUniform2f" . 489)
     ("glProgramUniform2fv" . 490)
     ("glProgramUniform2i" . 491)
     ("glProgramUniform2iv" . 492)
     ("glProgramUniform2ui" . 493)
     ("glProgramUniform2uiv" . 494)
     ("glProgramUniform3d" . 495)
     ("glProgramUniform3dv" . 496)
     ("glProgramUniform3f" . 497)
     ("glProgramUniform3fv" . 498)
     ("glProgramUniform3i" . 499)
     ("glProgramUniform3iv" . 500)
     ("glProgramUniform3ui" . 501)
     ("glProgramUniform3uiv" . 502)
     ("glProgramUniform4d" . 503)
     ("glProgramUniform4dv" . 504)
     ("glProgramUniform4f" . 505)
     ("glProgramUniform4fv" . 506)
     ("glProgramUniform4i" . 507)
     ("glProgramUniform4iv" . 508)
     ("glProgramUniform4ui" . 509)
     ("glProgramUniform4uiv" . 510)
     ("glProgramUniformMatrix2dv" . 511)
     ("glProgramUniformMatrix2fv" . 512)
     ("glProgramUniformMatrix2x3dv" . 513)
     ("glProgramUniformMatrix2x3fv" . 514)
     ("glProgramUniformMatrix2x4dv" . 515)
     ("glProgramUniformMatrix2x4fv" . 516)
     ("glProgramUniformMatrix3dv" . 517)
     ("glProgramUniformMatrix3fv" . 518)
     ("glProgramUniformMatrix3x2dv" . 519)
     ("glProgramUniformMatrix3x2fv" . 520)
     ("glProgramUniformMatrix3x4dv" . 521)
     ("glProgramUniformMatrix3x4fv" . 522)
     ("glProgramUniformMatrix4dv" . 523)
     ("glProgramUniformMatrix4fv" . 524)
     ("glProgramUniformMatrix4x2dv" . 525)
     ("glProgramUniformMatrix4x2fv" . 526)
     ("glProgramUniformMatrix4x3dv" . 527)
     ("glProgramUniformMatrix4x3fv" . 528)
     ("glProvokingVertex" . 529)
     ("glPushAttrib" . 530)
     ("glPushClientAttrib" . 531)
     ("glPushMatrix" . 532)
     ("glPushName" . 533)
     ("glQueryCounter" . 534)
     ("glRasterPos2d" . 535)
     ("glRasterPos2dv" . 536)
     ("glRasterPos2f" . 537)
     ("glRasterPos2fv" . 538)
     ("glRasterPos2i" . 539)
     ("glRasterPos2iv" . 540)
     ("glRasterPos2s" . 541)
     ("glRasterPos2sv" . 542)
     ("glRasterPos3d" . 543)
     ("glRasterPos3dv" . 544)
     ("glRasterPos3f" . 545)
     ("glRasterPos3fv" . 546)
     ("glRasterPos3i" . 547)
     ("glRasterPos3iv" . 548)
     ("glRasterPos3s" . 549)
     ("glRasterPos3sv" . 550)
     ("glRasterPos4d" . 551)
     ("glRasterPos4dv" . 552)
     ("glRasterPos4f" . 553)
     ("glRasterPos4fv" . 554)
     ("glRasterPos4i" . 555)
     ("glRasterPos4iv" . 556)
     ("glRasterPos4s" . 557)
     ("glRasterPos4sv" . 558)
     ("glReadBuffer" . 559)
     ("glReadPixels" . 560)
     ("glRectd" . 561)
     ("glRectdv" . 562)
     ("glRectf" . 563)
     ("glRectfv" . 564)
     ("glRecti" . 565)
     ("glRectiv" . 566)
     ("glRects" . 567)
     ("glRectsv" . 568)
     ("glReleaseShaderCompiler" . 569)
     ("glRenderMode" . 570)
     ("glRenderbufferStorage" . 571)
     ("glRenderbufferStorageMultisample" . 572)
     ("glResetHistogram" . 573)
     ("glResetMinmax" . 574)
     ("glResumeTransformFeedback" . 575)
     ("glRotated" . 576)
     ("glRotatef" . 577)
     ("glSampleCoverage" . 578)
     ("glSampleMaski" . 579)
     ("glSamplerParameterIiv" . 580)
     ("glSamplerParameterIuiv" . 581)
     ("glSamplerParameterf" . 582)
     ("glSamplerParameterfv" . 583)
     ("glSamplerParameteri" . 584)
     ("glSamplerParameteriv" . 585)
     ("glScaled" . 586)
     ("glScalef" . 587)
     ("glScissor" . 588)
     ("glScissorArrayv" . 589)
     ("glScissorIndexed" . 590)
     ("glScissorIndexedv" . 591)
     ("glSecondaryColor3b" . 592)
     ("glSecondaryColor3bv" . 593)
     ("glSecondaryColor3d" . 594)
     ("glSecondaryColor3dv" . 595)
     ("glSecondaryColor3f" . 596)
     ("glSecondaryColor3fv" . 597)
     ("glSecondaryColor3i" . 598)
     ("glSecondaryColor3iv" . 599)
     ("glSecondaryColor3s" . 600)
     ("glSecondaryColor3sv" . 601)
     ("glSecondaryColor3ub" . 602)
     ("glSecondaryColor3ubv" . 603)
     ("glSecondaryColor3ui" . 604)
     ("glSecondaryColor3uiv" . 605)
     ("glSecondaryColor3us" . 606)
     ("glSecondaryColor3usv" . 607)
     ("glSecondaryColorPointer" . 608)
     ("glSelectBuffer" . 609)
     ("glSeparableFilter2D" . 610)
     ("glShadeModel" . 611)
     ("glShaderBinary" . 612)
     ("glShaderSource" . 613)
     ("glStencilFunc" . 614)
     ("glStencilFuncSeparate" . 615)
     ("glStencilMask" . 616)
     ("glStencilMaskSeparate" . 617)
     ("glStencilOp" . 618)
     ("glStencilOpSeparate" . 619)
     ("glTexBuffer" . 620)
     ("glTexCoord1d" . 621)
     ("glTexCoord1dv" . 622)
     ("glTexCoord1f" . 623)
     ("glTexCoord1fv" . 624)
     ("glTexCoord1i" . 625)
     ("glTexCoord1iv" . 626)
     ("glTexCoord1s" . 627)
     ("glTexCoord1sv" . 628)
     ("glTexCoord2d" . 629)
     ("glTexCoord2dv" . 630)
     ("glTexCoord2f" . 631)
     ("glTexCoord2fv" . 632)
     ("glTexCoord2i" . 633)
     ("glTexCoord2iv" . 634)
     ("glTexCoord2s" . 635)
     ("glTexCoord2sv" . 636)
     ("glTexCoord3d" . 637)
     ("glTexCoord3dv" . 638)
     ("glTexCoord3f" . 639)
     ("glTexCoord3fv" . 640)
     ("glTexCoord3i" . 641)
     ("glTexCoord3iv" . 642)
     ("glTexCoord3s" . 643)
     ("glTexCoord3sv" . 644)
     ("glTexCoord4d" . 645)
     ("glTexCoord4dv" . 646)
     ("glTexCoord4f" . 647)
     ("glTexCoord4fv" . 648)
     ("glTexCoord4i" . 649)
     ("glTexCoord4iv" . 650)
     ("glTexCoord4s" . 651)
     ("glTexCoord4sv" . 652)
     ("glTexCoordPointer" . 653)
     ("glTexEnvf" . 654)
     ("glTexEnvfv" . 655)
     ("glTexEnvi" . 656)
     ("glTexEnviv" . 657)
     ("glTexGend" . 658)
     ("glTexGendv" . 659)
     ("glTexGenf" . 660)
     ("glTexGenfv" . 661)
     ("glTexGeni" . 662)
     ("glTexGeniv" . 663)
     ("glTexImage1D" . 664)
     ("glTexImage2D" . 665)
     ("glTexImage2DMultisample" . 666)
     ("glTexImage3D" . 667)
     ("glTexImage3DMultisample" . 668)
     ("glTexParameterIiv" . 669)
     ("glTexParameterIuiv" . 670)
     ("glTexParameterf" . 671)
     ("glTexParameterfv" . 672)
     ("glTexParameteri" . 673)
     ("glTexParameteriv" . 674)
     ("glTexSubImage1D" . 675)
     ("glTexSubImage2D" . 676)
     ("glTexSubImage3D" . 677)
     ("glTransformFeedbackVaryings" . 678)
     ("glTranslated" . 679)
     ("glTranslatef" . 680)
     ("glUniform1d" . 681)
     ("glUniform1dv" . 682)
     ("glUniform1f" . 683)
     ("glUniform1fv" . 684)
     ("glUniform1i" . 685)
     ("glUniform1iv" . 686)
     ("glUniform1ui" . 687)
     ("glUniform1uiv" . 688)
     ("glUniform2d" . 689)
     ("glUniform2dv" . 690)
     ("glUniform2f" . 691)
     ("glUniform2fv" . 692)
     ("glUniform2i" . 693)
     ("glUniform2iv" . 694)
     ("glUniform2ui" . 695)
     ("glUniform2uiv" . 696)
     ("glUniform3d" . 697)
     ("glUniform3dv" . 698)
     ("glUniform3f" . 699)
     ("glUniform3fv" . 700)
     ("glUniform3i" . 701)
     ("glUniform3iv" . 702)
     ("glUniform3ui" . 703)
     ("glUniform3uiv" . 704)
     ("glUniform4d" . 705)
     ("glUniform4dv" . 706)
     ("glUniform4f" . 707)
     ("glUniform4fv" . 708)
     ("glUniform4i" . 709)
     ("glUniform4iv" . 710)
     ("glUniform4ui" . 711)
     ("glUniform4uiv" . 712)
     ("glUniformBlockBinding" . 713)
     ("glUniformMatrix2dv" . 714)
     ("glUniformMatrix2fv" . 715)
     ("glUniformMatrix2x3dv" . 716)
     ("glUniformMatrix2x3fv" . 717)
     ("glUniformMatrix2x4dv" . 718)
     ("glUniformMatrix2x4fv" . 719)
     ("glUniformMatrix3dv" . 720)
     ("glUniformMatrix3fv" . 721)
     ("glUniformMatrix3x2dv" . 722)
     ("glUniformMatrix3x2fv" . 723)
     ("glUniformMatrix3x4dv" . 724)
     ("glUniformMatrix3x4fv" . 725)
     ("glUniformMatrix4dv" . 726)
     ("glUniformMatrix4fv" . 727)
     ("glUniformMatrix4x2dv" . 728)
     ("glUniformMatrix4x2fv" . 729)
     ("glUniformMatrix4x3dv" . 730)
     ("glUniformMatrix4x3fv" . 731)
     ("glUniformSubroutinesuiv" . 732)
     ("glUnmapBuffer" . 733)
     ("glUseProgram" . 734)
     ("glUseProgramStages" . 735)
     ("glValidateProgram" . 736)
     ("glValidateProgramPipeline" . 737)
     ("glVertex2d" . 738)
     ("glVertex2dv" . 739)
     ("glVertex2f" . 740)
     ("glVertex2fv" . 741)
     ("glVertex2i" . 742)
     ("glVertex2iv" . 743)
     ("glVertex2s" . 744)
     ("glVertex2sv" . 745)
     ("glVertex3d" . 746)
     ("glVertex3dv" . 747)
     ("glVertex3f" . 748)
     ("glVertex3fv" . 749)
     ("glVertex3i" . 750)
     ("glVertex3iv" . 751)
     ("glVertex3s" . 752)
     ("glVertex3sv" . 753)
     ("glVertex4d" . 754)
     ("glVertex4dv" . 755)
     ("glVertex4f" . 756)
     ("glVertex4fv" . 757)
     ("glVertex4i" . 758)
     ("glVertex4iv" . 759)
     ("glVertex4s" . 760)
     ("glVertex4sv" . 761)
     ("glVertexAttrib1d" . 762)
     ("glVertexAttrib1dv" . 763)
     ("glVertexAttrib1f" . 764)
     ("glVertexAttrib1fv" . 765)
     ("glVertexAttrib1s" . 766)
     ("glVertexAttrib1sv" . 767)
     ("glVertexAttrib2d" . 768)
     ("glVertexAttrib2dv" . 769)
     ("glVertexAttrib2f" . 770)
     ("glVertexAttrib2fv" . 771)
     ("glVertexAttrib2s" . 772)
     ("glVertexAttrib2sv" . 773)
     ("glVertexAttrib3d" . 774)
     ("glVertexAttrib3dv" . 775)
     ("glVertexAttrib3f" . 776)
     ("glVertexAttrib3fv" . 777)
     ("glVertexAttrib3s" . 778)
     ("glVertexAttrib3sv" . 779)
     ("glVertexAttrib4Nbv" . 780)
     ("glVertexAttrib4Niv" . 781)
     ("glVertexAttrib4Nsv" . 782)
     ("glVertexAttrib4Nub" . 783)
     ("glVertexAttrib4Nubv" . 784)
     ("glVertexAttrib4Nuiv" . 785)
     ("glVertexAttrib4Nusv" . 786)
     ("glVertexAttrib4bv" . 787)
     ("glVertexAttrib4d" . 788)
     ("glVertexAttrib4dv" . 789)
     ("glVertexAttrib4f" . 790)
     ("glVertexAttrib4fv" . 791)
     ("glVertexAttrib4iv" . 792)
     ("glVertexAttrib4s" . 793)
     ("glVertexAttrib4sv" . 794)
     ("glVertexAttrib4ubv" . 795)
     ("glVertexAttrib4uiv" . 796)
     ("glVertexAttrib4usv" . 797)
     ("glVertexAttribDivisor" . 798)
     ("glVertexAttribI1i" . 799)
     ("glVertexAttribI1iv" . 800)
     ("glVertexAttribI1ui" . 801)
     ("glVertexAttribI1uiv" . 802)
     ("glVertexAttribI2i" . 803)
     ("glVertexAttribI2iv" . 804)
     ("glVertexAttribI2ui" . 805)
     ("glVertexAttribI2uiv" . 806)
     ("glVertexAttribI3i" . 807)
     ("glVertexAttribI3iv" . 808)
     ("glVertexAttribI3ui" . 809)
     ("glVertexAttribI3uiv" . 810)
     ("glVertexAttribI4bv" . 811)
     ("glVertexAttribI4i" . 812)
     ("glVertexAttribI4iv" . 813)
     ("glVertexAttribI4sv" . 814)
     ("glVertexAttribI4ubv" . 815)
     ("glVertexAttribI4ui" . 816)
     ("glVertexAttribI4uiv" . 817)
     ("glVertexAttribI4usv" . 818)
     ("glVertexAttribIPointer" . 819)
     ("glVertexAttribL1d" . 820)
     ("glVertexAttribL1dv" . 821)
     ("glVertexAttribL2d" . 822)
     ("glVertexAttribL2dv" . 823)
     ("glVertexAttribL3d" . 824)
     ("glVertexAttribL3dv" . 825)
     ("glVertexAttribL4d" . 826)
     ("glVertexAttribL4dv" . 827)
     ("glVertexAttribLPointer" . 828)
     ("glVertexAttribP1ui" . 829)
     ("glVertexAttribP1uiv" . 830)
     ("glVertexAttribP2ui" . 831)
     ("glVertexAttribP2uiv" . 832)
     ("glVertexAttribP3ui" . 833)
     ("glVertexAttribP3uiv" . 834)
     ("glVertexAttribP4ui" . 835)
     ("glVertexAttribP4uiv" . 836)
     ("glVertexAttribPointer" . 837)
     ("glVertexPointer" . 838)
     ("glViewport" . 839)
     ("glViewportArrayv" . 840)
     ("glViewportIndexedf" . 841)
     ("glViewportIndexedfv" . 842)
     ("glWaitSync" . 843)
     ("glWindowPos2d" . 844)
     ("glWindowPos2dv" . 845)
     ("glWindowPos2f" . 846)
     ("glWindowPos2fv" . 847)
     ("glWindowPos2i" . 848)
     ("glWindowPos2iv" . 849)
     ("glWindowPos2s" . 850)
     ("glWindowPos2sv" . 851)
     ("glWindowPos3d" . 852)
     ("glWindowPos3dv" . 853)
     ("glWindowPos3f" . 854)
     ("glWindowPos3fv" . 855)
     ("glWindowPos3i" . 856)
     ("glWindowPos3iv" . 857)
     ("glWindowPos3s" . 858)
     ("glWindowPos3sv" . 859))))

(define impc:ti:gl-proc-alist-index
  (let ()
    (lambda (gl-proc-name)
      (let ((res (assoc-strcmp gl-proc-name *impc:ti:gl-proc-alist*)))
        (if res (cdr res) #f)))))

(define impc:aot:insert-gl-proc-binding-details
  (lambda (lib-name proc-name type docstring)
    (if (and (output-port? *impc:aot:current-output-port*)
             ;; ignore the binding if we're just binding something
             ;; from an Extempore AOT-compiled library
             (not (and (>= (string-length (atom->string lib-name)) 3)
                       (string=? "xtm" (substring (atom->string lib-name) 0 3)))))
        (begin
          (write
           (list 'bind-gl-proc lib-name proc-name type docstring)
           *impc:aot:current-output-port*)
          (newline *impc:aot:current-output-port*)))))

(define glwrapper-arg-list-symbols
  (lambda (arity)
    (map (lambda (i)
           (string->symbol (string-append "arg" (number->string (+ i 1)))))
         (range arity))))

(define-macro (bind-gl-proc gl-lib proc-name type . args)
  (let* ((arg-types (cddr (impc:ir:get-type-from-pretty-str (symbol->string type))))
         (arg-list (glwrapper-arg-list-symbols (length arg-types)))
         (index (impc:ti:gl-proc-alist-index (symbol->string proc-name))))
    (if (not index)
        (impc:compiler:print-compiler-error (string-append "couldn't find GLproc index for " (symbol->string proc-name))))
    `(eval (bind-func ,proc-name
             ;; docstring
             ,(if (and (not (null? args)) (string? (car args)))
                  (car args)
                  "")
             (lambda ,arg-list
               ;; print the function pointer - useful for debugging
               ;; (println ,(symbol->string proc-name)
               ;;          (aref EXTEMPORE_GL_FUNCTION_POINTERS ,index))
               (fptrcall (cast (aref EXTEMPORE_GL_FUNCTION_POINTERS
                                     ,index)
                               ,type)
                         ,@arg-list)))
           (interaction-environment))))

;; (impc:ti:register-new-builtin
;;  "bind-gl-proc"
;;  ""
;;  "bind an OpenGL procedure"
;;  '(libname function-name type optional-docstring))

(impc:aot:do-and-emit
 (if (not (impc:aot:currently-compiling?))
     (let ((platform (sys:platform)))
       (cond ((string=? platform "OSX")
              (eval '(bind-func gl_get_proc_address
                       (lambda (lib:i8* name:i8*)
                         (if (not (null? lib))
                             (dlsym lib name)
                             null)))
                    (interaction-environment)))

             ((string=? platform "Linux")
              (eval '(bind-lib libGL glXGetProcAddressARB [i8*,i8*]*)
                    (interaction-environment))
              (eval '(bind-func gl_get_proc_address
                       (lambda (lib:i8* name:i8*)
                         (glXGetProcAddressARB name)))
                    (interaction-environment)))

             ((string=? platform "Windows")
              (eval '(bind-lib libGL wglGetProcAddress [i8*,i8*]*)
                    (interaction-environment))
              (eval '(bind-func gl_get_proc_address
                       (lambda (lib:i8* name:i8*)
                         (wglGetProcAddress name)))
                    (interaction-environment)))

             (else (impc:compiler:print-compiler-error
                    "unknown platform, cannot load platform-specific gl_get_proc_address for OpenGL"))))))

;; ;; On Windows, we need a function to check if our proc ptr is valid
;; (bind-func gl_proc_address_valid_p
;;   "valid proc address is anything other than -1, 0, 1, 2, 3, 4 or 5"
;;   (lambda (addr:i8*)
;;     (or (< (convert addr i64) -1)
;;         (> (convert addr i64) 5))))

;; if you change this, change the size of
;; EXTEMPORE_GL_FUNCTION_POINTERS as well!
(bind-val EXTEMPORE_GL_FUNCTION_POINTER_COUNT i64 860
  "the size of the EXTEMPORE_GL_FUNCTION_POINTERS array

equal to (length *impc:ti:gl-proc-alist*)")

(bind-val EXTEMPORE_GL_FUNCTION_POINTERS |860,i8*|
  "global i8* array for storing OpenGL function pointers")

(bind-func gl_set_proc_address
  (lambda (index proc-fptr)
    (if (or (< index 0)
            (> index (- EXTEMPORE_GL_FUNCTION_POINTER_COUNT 1)))
        (println "Error in gl_set_proc_address: index must be between 0 and EXTEMPORE_GL_FUNCTION_POINTER_COUNT")
        (begin
          (aset! EXTEMPORE_GL_FUNCTION_POINTERS index proc-fptr)
          void))))

(impc:aot:do-and-emit
 (define cptr-null?
   (lambda (cptr)
     (and (cptr? cptr)
          (string=? (cptr->string cptr) "")))))

;; it would be nice if this was an xtlang function, but for now the
;; list of gl proc names is in Scheme
(impc:aot:do-and-emit
 (define gl_init
   (lambda (gl-lib . warn?)
     (for-each (lambda (proc-pair)
                 (let* ((proc-ptr (gl_get_proc_address gl-lib (car proc-pair))))
                   ;; On Windows, additionally check GetProcAddress
                   (if (cptr-null? proc-ptr)
                       (set! proc-ptr (sys:symbol-cptr libGL (car proc-pair))))
                   (if (and proc-ptr (not (cptr-null? proc-ptr)))
                       (gl_set_proc_address (cdr proc-pair) proc-ptr)
                       (if (and (not (null? warn?)) warn?)
                           (print "Warning: OpenGL proc address is null for " (car proc-pair) "\n")))))
               *impc:ti:gl-proc-alist*)
     (print "done\n"))))
